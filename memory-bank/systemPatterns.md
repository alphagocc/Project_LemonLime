# System Patterns - 系统架构与设计模式

## 整体架构模式

### 1. 分层架构 (Layered Architecture)
```
┌─────────────────────────────────────┐
│           用户界面层 (UI Layer)      │
├─────────────────────────────────────┤
│         业务逻辑层 (Business Layer)  │
├─────────────────────────────────────┤
│         数据访问层 (Data Layer)      │
├─────────────────────────────────────┤
│         核心评测层 (Core Layer)      │
└─────────────────────────────────────┘
```

#### 用户界面层
- **主窗口** (`lemon.cpp/h`): 应用程序主入口，协调各组件
- **对话框系统**: 向导式配置 (AddCompilerWizard, AddTestCasesWizard)
- **设置界面**: 分模块配置 (GeneralSettings, CompilerSettings, VisualSettings)
- **结果显示**: 表格化展示 (ResultViewer, SummaryTree, StatisticsBrowser)

#### 业务逻辑层
- **比赛管理** (`contest.cpp/h`): 核心业务流程控制
- **评测调度** (`judgingcontroller.cpp/h`, `taskjudger.cpp/h`): 任务分配和执行
- **参赛者管理** (`contestant.cpp/h`): 选手信息和成绩管理

#### 数据访问层
- **配置管理** (`settings.cpp/h`): 应用程序设置持久化
- **序列化支持**: JSON和二进制格式的数据读写
- **文件系统**: 测试用例和源代码管理

#### 核心评测层
- **评测引擎** (`judgingthread.cpp/h`): 程序执行和结果判定
- **编译器管理** (`compiler.cpp/h`, `src/base/compiler.*`): 多语言支持
- **测试用例** (`testcase.cpp/h`): 测试数据管理

### 2. 插件化架构 (Plugin Architecture)
- **编译器插件**: 支持多种编程语言的动态加载
- **评测模式插件**: 传统评测、答案评测、特殊评测
- **比较模式插件**: 行比较、忽略空格、实数比较、自定义diff

## 核心设计模式

### 1. 模型-视图-控制器 (MVC)
```
Model: Contest, Task, TestCase, Contestant
View: ResultViewer, SummaryTree, StatisticsBrowser
Controller: LemonLime, TaskJudger, JudgingController
```

### 2. 观察者模式 (Observer Pattern)
- **信号槽机制**: Qt内置的观察者模式实现
- **事件通知**: 评测状态变化、任务完成通知
- **数据同步**: 模型数据变化自动更新视图

### 3. 工厂模式 (Factory Pattern)
- **编译器创建**: 根据类型动态创建编译器实例
- **任务创建**: 支持不同类型的任务创建
- **评测器创建**: 根据任务类型选择合适的评测策略

### 4. 策略模式 (Strategy Pattern)
- **评测策略**: 传统评测 vs 答案评测 vs 特殊评测
- **比较策略**: 多种输出比较算法
- **编译策略**: 不同语言的编译和运行方式

### 5. 单例模式 (Singleton Pattern)
- **应用程序实例**: SingleApplication确保单实例运行
- **设置管理**: 全局设置对象的统一管理
- **日志系统**: 集中化的日志管理

## 关键组件关系

### 1. 评测流程控制
```
Contest → TaskJudger → JudgingThread → Compiler
   ↓         ↓            ↓            ↓
Contestant  Task      TestCase     Execution
```

### 2. 数据流架构
```
输入: 源代码 + 测试用例 → 编译 → 执行 → 比较 → 结果输出
存储: JSON/二进制格式持久化，支持导入导出
显示: 表格化结果展示，统计图表生成
```

### 3. 并发处理模型
- **线程池模式**: 限制最大评测线程数
- **任务队列**: 评测任务的有序执行
- **状态同步**: 线程安全的评测状态更新

## 技术架构决策

### 1. 跨平台策略
- **Qt框架**: 一次编写，多平台运行
- **文件系统抽象**: 统一的路径和文件处理
- **进程管理**: 跨平台的程序执行控制

### 2. 性能优化
- **内存管理**: 智能指针和对象池
- **文件缓存**: 测试用例和编译结果缓存
- **增量评测**: 只重新评测变化的部分

### 3. 扩展性设计
- **模块化架构**: 功能模块独立开发和测试
- **配置驱动**: 通过配置支持新功能
- **插件接口**: 预留扩展点供未来增强

### 4. 可靠性保障
- **错误处理**: 完善的异常处理机制
- **资源管理**: RAII模式管理资源
- **状态恢复**: 评测中断后的状态恢复

## 数据模型设计

### 1. 核心实体关系
```
Contest (1) → (N) Task
Task (1) → (N) TestCase  
Contest (1) → (N) Contestant
Contestant (N) → (N) Task (通过成绩关联)
```

### 2. 配置管理模型
- **分层配置**: 全局设置 → 比赛设置 → 任务设置
- **继承机制**: 子设置继承父设置，支持覆盖
- **版本控制**: 配置变更的历史记录

### 3. 评测结果模型
- **多维度结果**: 编译状态、运行结果、时间内存使用
- **层次化评分**: 测试用例 → 子任务 → 任务 → 总分
- **详细日志**: 完整的评测过程记录

## 安全与隔离

### 1. 程序隔离
- **沙箱执行**: 限制程序资源和文件系统访问
- **时间限制**: 防止无限循环和资源耗尽
- **内存限制**: 防止内存泄漏和耗尽

### 2. 数据安全
- **文件权限**: 保护测试数据和评测结果
- **输入验证**: 防止恶意输入和注入攻击
- **日志审计**: 完整的操作记录和追踪

## 国际化支持

### 1. 多语言架构
- **Qt Linguist集成**: 专业的翻译管理工具
- **运行时切换**: 支持动态语言切换
- **区域设置**: 适应不同地区的格式要求

### 2. 本地化考虑
- **文本方向**: 支持从左到右和从右到左的文本
- **数字格式**: 适应不同地区的数字表示
- **时间格式**: 本地化的时间显示格式
